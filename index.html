<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏ß‡∏á‡∏•‡πâ‡∏≠‡∏™‡∏∏‡πà‡∏°‡∏ú‡∏π‡πâ‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ</title>
  <style>
    body {
      margin: 0;
      background: radial-gradient(circle at center, #1e293b, #0f172a);
      color: #fff;
      font-family: "Prompt", sans-serif;
      overflow: hidden;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    #wheelCanvas {
      width: 80vw;
      height: 80vh;
      max-height: 800px;
      aspect-ratio: 16/9;
    }
    #controls {
      position: absolute;
      bottom: 5%;
      display: flex;
      gap: 1rem;
    }
    button {
      background: #22c55e;
      color: white;
      border: none;
      border-radius: 12px;
      padding: 14px 28px;
      font-size: 1.1rem;
      cursor: pointer;
      transition: 0.3s;
    }
    button:hover {
      background: #16a34a;
      transform: scale(1.05);
    }
    #popup, #winnerPopup {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .popup-content {
      background: #1e293b;
      padding: 30px;
      border-radius: 16px;
      text-align: center;
      color: white;
      width: 400px;
    }
    input {
      width: 80%;
      padding: 10px;
      margin: 10px 0;
      border: none;
      border-radius: 8px;
      text-align: center;
      font-size: 1rem;
    }
    #winnerPopup {
      font-size: 2rem;
      color: #fff;
      flex-direction: column;
    }
    #winnerPopup h2 {
      color: #facc15;
      font-size: 2.5rem;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <canvas id="wheelCanvas"></canvas>

  <div id="controls">
    <button id="spinButton">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏´‡∏°‡∏∏‡∏ô</button>
    <button id="resetButton">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏∞‡∏ö‡∏ö</button>
  </div>

  <div id="popup">
    <div class="popup-content">
      <h2>‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</h2>
      <input type="text" id="nameInput" placeholder="‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà">
      <br>
      <button id="addName">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠</button>
      <p id="timer">‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤: 3:00 ‡∏ô‡∏≤‡∏ó‡∏µ</p>
    </div>
  </div>

  <div id="winnerPopup" style="display:none;">
    <h2>üéâ ‡∏ú‡∏π‡πâ‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ‡∏Ñ‡∏∑‡∏≠ üéâ</h2>
    <p id="winnerName"></p>
  </div>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbwnOwUGXJHANHxX8qbNWaDPeUxHTAz2M3JHED-fyaJps9vStSBJB7VzCnn-4KO_ascJVw/exec";

    const canvas = document.getElementById("wheelCanvas");
    const ctx = canvas.getContext("2d");
    const popup = document.getElementById("popup");
    const nameInput = document.getElementById("nameInput");
    const addNameBtn = document.getElementById("addName");
    const spinButton = document.getElementById("spinButton");
    const resetButton = document.getElementById("resetButton");
    const winnerPopup = document.getElementById("winnerPopup");
    const winnerNameEl = document.getElementById("winnerName");
    const timerEl = document.getElementById("timer");

    let names = [];
    let winners = [];
    let spinning = false;
    let startAngle = 0;
    let spinTimeout = null;

    // ‡∏à‡∏±‡∏î‡∏Ç‡∏ô‡∏≤‡∏î canvas ‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ‡∏Å‡∏±‡∏ö‡∏à‡∏≠
    function resizeCanvas() {
      canvas.width = window.innerWidth * 0.8;
      canvas.height = (canvas.width * 9) / 16;
      drawWheel();
    }
    window.addEventListener("resize", resizeCanvas);

    function drawWheel() {
      const outsideRadius = canvas.height / 2 - 10;
      const textRadius = outsideRadius - 40;
      const insideRadius = 0;
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      const arc = (2 * Math.PI) / names.length;

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      for (let i = 0; i < names.length; i++) {
        const angle = startAngle + i * arc;
        ctx.beginPath();
        ctx.fillStyle = i % 2 ? "#60a5fa" : "#3b82f6";
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, outsideRadius, angle, angle + arc, false);
        ctx.fill();

        ctx.save();
        ctx.fillStyle = "white";
        ctx.translate(centerX, centerY);
        ctx.rotate(angle + arc / 2);
        ctx.textAlign = "right";
        ctx.font = "bold 22px Prompt";
        ctx.fillText(names[i], textRadius, 10);
        ctx.restore();
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏°‡∏∏‡∏ô‡∏ß‡∏á‡∏•‡πâ‡∏≠
    function spin() {
      if (spinning || names.length === 0) return;
      spinning = true;
      const spins = 10 + Math.random() * 10;
      const endAngle = startAngle + spins * 2 * Math.PI;
      const duration = 5000;
      const startTime = performance.now();

      const audio = new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg");
      audio.play();

      function animate(time) {
        const progress = Math.min((time - startTime) / duration, 1);
        startAngle = endAngle * easeOut(progress);
        drawWheel();
        if (progress < 1) {
          requestAnimationFrame(animate);
        } else {
          spinning = false;
          const index = Math.floor(names.length - (startAngle / (2 * Math.PI)) % names.length) % names.length;
          const winner = names[index];
          winners.push(winner);
          showWinner(winner);
          names.splice(index, 1);
          saveToGoogleSheet("winner", winner);
        }
      }
      requestAnimationFrame(animate);
    }

    function easeOut(t) {
      return 1 - Math.pow(1 - t, 3);
    }

    function showWinner(winner) {
      winnerPopup.style.display = "flex";
      winnerNameEl.textContent = winner;

      const cheer = new Audio("https://actions.google.com/sounds/v1/ambiences/crowd_cheer.ogg");
      cheer.play();

      setTimeout(() => {
        winnerPopup.style.display = "none";
        drawWheel();
      }, 4000);
    }

    addNameBtn.onclick = () => {
      const name = nameInput.value.trim();
      if (name && !names.includes(name)) {
        names.push(name);
        saveToGoogleSheet("name", name);
        nameInput.value = "";
      }
    };

    spinButton.onclick = spin;

    resetButton.onclick = () => {
      localStorage.clear();
      names = [];
      winners = [];
      drawWheel();
      location.reload();
    };

    // ‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á 3 ‡∏ô‡∏≤‡∏ó‡∏µ
    let timeLeft = 180;
    const countdown = setInterval(() => {
      timeLeft--;
      const min = Math.floor(timeLeft / 60);
      const sec = timeLeft % 60;
      timerEl.textContent = `‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤: ${min}:${sec.toString().padStart(2, "0")} ‡∏ô‡∏≤‡∏ó‡∏µ`;
      if (timeLeft <= 0) {
        clearInterval(countdown);
        popup.style.display = "none";
        drawWheel();
      }
    }, 1000);

    function saveToGoogleSheet(action, name) {
      fetch(scriptURL, {
        method: "POST",
        body: new URLSearchParams({ action, name }),
      }).catch(err => console.error(err));
    }

    resizeCanvas();
  </script>
</body>
</html>
