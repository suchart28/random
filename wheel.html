<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏ß‡∏á‡∏•‡πâ‡∏≠‡∏ú‡∏π‡πâ‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ</title>
<style>
  body { font-family: Arial; text-align:center; background:#f0f8ff; padding:10px; margin:0; }
  h1 { font-size:2em; margin:10px 0; }
  #wheelContainer { margin:20px auto; width:90vw; max-width:400px; height:90vw; max-height:400px; position:relative; }
  #wheel { width:100%; height:100%; transform-origin:50% 50%; }
  button { padding:10px 20px; font-size:16px; border:none; border-radius:5px; background:#4CAF50; color:white; cursor:pointer; margin:5px; transition:0.3s; }
  button:hover { background:#45a049; }
  #winnerList { margin-top:20px; font-size:16px; text-align:left; max-width:400px; margin-left:auto; margin-right:auto; }
  #popup {
    display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
    background:#fff; padding:30px 50px; border-radius:20px; box-shadow:0 0 20px rgba(0,0,0,0.3);
    z-index:999; font-size:24px; font-weight:bold; text-align:center;
  }
  #popup.show { display:block; animation:pop 0.5s ease-out; }
  @keyframes pop { 0% { transform:translate(-50%, -50%) scale(0.3); opacity:0; } 100% { transform:translate(-50%, -50%) scale(1); opacity:1; } }
</style>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
  import { getDatabase, ref, onValue, remove, push } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";
  import JSConfetti from 'https://cdn.jsdelivr.net/npm/js-confetti@0.11.0/dist/js-confetti.browser.js';

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyDGYuI3yxJbUTc6T_0pm6WiEKZul11tXS0",
    authDomain: "suchartwork-1487382986748.firebaseapp.com",
    databaseURL: "https://suchartwork-1487382986748.firebaseio.com",
    projectId: "suchartwork-1487382986748",
    storageBucket: "suchartwork-1487382986748.firebasestorage.app",
    messagingSenderId: "353884592527",
    appId: "1:353884592527:web:59730eceafe78fadeb13fa"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const jsConfetti = new JSConfetti();

  const wheelContainer = document.getElementById('wheelContainer');
  const winnerList = document.getElementById('winners');
  const popup = document.getElementById('popup');
  const spinBtn = document.getElementById('spinBtn');
  const resetBtn = document.getElementById('resetBtn');
  const winSound = new Audio("https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3");

  let names = [];
  let winners = [];
  let spinning=false;
  let rotation=0;

  // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÅ‡∏ö‡∏ö realtime
  const participantsRef = ref(db,'participants');
  onValue(participantsRef, snapshot => {
    names=[];
    snapshot.forEach(child => names.push(child.val()));
    drawWheel(); // ‡∏ß‡∏≤‡∏î‡∏ß‡∏á‡∏•‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à
  });

  // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ‡πÅ‡∏ö‡∏ö realtime
  const winnersRef = ref(db,'winners');
  onValue(winnersRef, snapshot => {
    winners=[];
    snapshot.forEach(child=>winners.push(child.val()));
    updateWinnerList();
  });

  function drawWheel(){
    wheelContainer.innerHTML='';
    const canvas = document.createElement('canvas');
    const size = Math.min(wheelContainer.clientWidth, wheelContainer.clientHeight);
    canvas.width = size;
    canvas.height = size;
    wheelContainer.appendChild(canvas);
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0,0,size,size);

    if(names.length===0){
      ctx.fillStyle="#ccc"; 
      ctx.beginPath(); 
      ctx.arc(size/2,size/2,size/2,0,2*Math.PI); 
      ctx.fill();
      ctx.fillStyle="#000"; 
      ctx.font=`bold ${Math.floor(size/15)}px Arial`; 
      ctx.textAlign="center"; 
      ctx.fillText("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°", size/2, size/2); 
      return;
    }

    const sliceAngle = 2*Math.PI/names.length;
    for(let i=0;i<names.length;i++){
      ctx.fillStyle = i%2===0 ? "#FFDD00" : "#FF8800";
      ctx.beginPath();
      ctx.moveTo(size/2,size/2);
      ctx.arc(size/2,size/2,size/2,i*sliceAngle,(i+1)*sliceAngle);
      ctx.closePath();
      ctx.fill();

      // ‡∏ß‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠
      ctx.save();
      ctx.translate(size/2,size/2);
      ctx.rotate(i*sliceAngle + sliceAngle/2);
      ctx.textAlign = "right";
      ctx.fillStyle="#000";
      ctx.font=`bold ${Math.floor(size/20)}px Arial`;
      ctx.fillText(names[i], size*0.45, 0);
      ctx.restore();
    }
  }

  function updateWinnerList(){
    winnerList.innerHTML='';
    winners.forEach(n=>{
      const li = document.createElement('li');
      li.textContent = n;
      winnerList.appendChild(li);
    });
  }

  function showPopup(winner){
    popup.textContent=`üéâ ‡∏ú‡∏π‡πâ‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ‡∏Ñ‡∏∑‡∏≠: ${winner} üéâ`;
    popup.classList.add('show');
    winSound.play();
    jsConfetti.addConfetti({emojis:['üéâ','üèÜ','üéä'], confettiNumber:200});
    setTimeout(()=>{ popup.classList.remove('show'); },3000);
  }

  function spinWheel(){
    if(spinning || names.length===0) return;
    spinning = true;
    const randomDegree = Math.floor(Math.random()*360)+720; // ‡∏´‡∏°‡∏∏‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 2 ‡∏£‡∏≠‡∏ö
    rotation += randomDegree;
    const wheel = document.getElementById('wheel');
    wheel.style.transition = "transform 4s cubic-bezier(0.33,1,0.68,1)";
    wheel.style.transform = `rotate(${rotation}deg)`;

    setTimeout(()=>{
      const sliceAngle = 360/names.length;
      const selectedIndex = Math.floor((360-(rotation%360))/sliceAngle)%names.length;
      const winner = names[selectedIndex];

      showPopup(winner);

      // ‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å participants
      onValue(participantsRef, snapshot=>{
        snapshot.forEach(child=>{
          if(child.val()===winner) remove(ref(db,'participants/'+child.key));
        });
      }, {once:true});

      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ‡πÑ‡∏õ winners
      push(ref(db,'winners'), winner);

      spinning = false;
      drawWheel();
    },4000);
  }

  function resetAll(){
    if(confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")){
      remove(ref(db,'participants'));
      remove(ref(db,'winners'));
      rotation=0;
    }
  }

  spinBtn.addEventListener('click',spinWheel);
  resetBtn.addEventListener('click',resetAll);

</script>
</head>
<body>
<h1>üé° ‡∏ß‡∏á‡∏•‡πâ‡∏≠‡∏™‡∏∏‡πà‡∏°‡∏ú‡∏π‡πâ‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå üé°</h1>
<div>
  <button id="spinBtn">‡∏´‡∏°‡∏∏‡∏ô‡∏ß‡∏á‡∏•‡πâ‡∏≠</button>
  <button id="resetBtn">Reset</button>
</div>
<div id="wheelContainer"></div>

<div id="winnerList">
<h3>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:</h3>
<ul id="winners"></ul>
</div>

<div id="popup"></div>
</body>
</html>
